# Push Notifications в Couply

## Обзор

Реализация Web Push уведомлений в приложении Couply позволяет отправлять пользователям уведомления даже когда браузер закрыт или свернут. Это важный канал коммуникации для уведомления о новых сообщениях, совпадениях и других событиях.

## Технические компоненты

1. **Service Worker** (`public/service-worker.js`)

   - Обрабатывает push-события от сервера
   - Отображает уведомления пользователю
   - Обрабатывает клики по уведомлениям

2. **PushNotificationService** (`src/shared/lib/services/PushNotificationService.ts`)

   - Содержит утилиты для работы с Push API
   - Регистрирует Service Worker
   - Создает и отправляет подписку на сервер
   - Отписывает пользователя от уведомлений

3. **usePushNotifications Hook** (`src/shared/lib/hooks/usePushNotifications.ts`)

   - React-хук для работы с уведомлениями
   - Предоставляет API для компонентов
   - Управляет состоянием подписки

4. **PushToggle Component** (`src/features/pushNotifications/components/PushToggle/PushToggle.tsx`)
   - UI-компонент для включения/отключения уведомлений
   - Использует usePushNotifications hook

## API Endpoints

Для работы с push-уведомлениями используются следующие API endpoints:

1. **POST /v1/push/subscribe**

   - Регистрирует новую подписку на сервере
   - Требует аутентификацию (User-Token в заголовке)
   - Тело запроса:
     ```json
     {
       "endpoint": "https://fcm.googleapis.com/fcm/send/...",
       "p256dh": "base64-encoded-key",
       "authKey": "base64-encoded-auth"
     }
     ```

2. **POST /v1/push/unsubscribe**
   - Отписывает пользователя от уведомлений
   - Требует аутентификацию (User-Token в заголовке)
   - Тело запроса:
     ```json
     {
       "endpoint": "https://fcm.googleapis.com/fcm/send/..."
     }
     ```

## Процесс подписки

1. Пользователь нажимает на кнопку "Включить уведомления"
2. Браузер показывает стандартный диалог разрешения уведомлений
3. При согласии:
   - Регистрируется Service Worker
   - Создается подписка через PushManager API
   - Данные подписки отправляются на сервер
4. При отказе:
   - Показывается сообщение о необходимости разрешить уведомления в настройках браузера

## Процесс отписки

1. Пользователь нажимает на кнопку "Отключить уведомления" в настройках
2. Клиент отправляет запрос на сервер для удаления подписки
3. Клиент вызывает `unsubscribe()` на объекте подписки в браузере

## Ограничения и особенности

1. **HTTPS обязателен** - Push API работает только по защищенному соединению
2. **Размер payload** - не более 4 КБ (сжатых)
3. **Совместимость** - не все браузеры поддерживают Web Push API
4. **Permissions** - пользователь может отозвать разрешение в настройках браузера

## Тестирование

Для локального тестирования:

1. Запустите приложение с HTTPS: `npm run start-https`
2. Используйте самоподписанный сертификат или ngrok для туннелирования
3. Проверьте подписку через переключатель в настройках
4. Проверьте получение уведомлений через инструменты разработчика (Application > Service Workers)
